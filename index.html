<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AimChamp/AimLab 密钥工坊</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Pako for Zlib (Deflate/Inflate) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #000000;
            color: #e5e5e5;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .mono-panel {
            background: #0a0a0a;
            border: 1px solid #333;
        }
        .mono-input {
            background: #000;
            border: 1px solid #333;
            color: #fff;
            transition: all 0.2s;
        }
        .mono-input:focus {
            border-color: #fff;
            outline: none;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #000; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper Functions ---
        const base64ToUint8Array = (base64) => {
            try {
                const binaryString = window.atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            } catch (e) {
                throw new Error("Base64 解码失败，请检查密钥格式");
            }
        };

        const uint8ArrayToBase64 = (bytes) => {
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        };

        const analyzeBytes = (dataView) => {
            const paramsList = [];
            const len = dataView.byteLength;

            for (let i = 0; i < len; i += 4) {
                if (i + 4 > len) break;

                const val_i = dataView.getInt32(i, true); 
                const val_f = dataView.getFloat32(i, true); 

                let is_float = false;
                if (Math.abs(val_f) < 10000 && Math.abs(val_f) > 0.0001) is_float = true;
                else if (val_f === 0.0) is_float = true;

                if (val_i >= -100 && val_i < 1000 && val_f !== 0) {
                    if (Math.abs(val_f) < 1e-10 || Math.abs(val_f) > 1e10) is_float = false;
                }

                paramsList.push({
                    id: i / 4,
                    type: is_float ? 'float' : 'int',
                    value: is_float ? val_f : val_i,
                    originalValue: is_float ? val_f : val_i // Track original for reset
                });
            }
            return paramsList;
        };

        const App = () => {
            // State
            const [inputKey, setInputKey] = useState("");
            const [decodedData, setDecodedData] = useState(null);
            const [paramsList, setParamsList] = useState([]);
            const [originalTaskId, setOriginalTaskId] = useState("");
            const [taskName, setTaskName] = useState("");
            const [description, setDescription] = useState("");
            const [outputKey, setOutputKey] = useState("");
            const [logs, setLogs] = useState([]);
            const [activeTab, setActiveTab] = useState('editor'); 
            const [searchTerm, setSearchTerm] = useState("");
            const fileInputRef = useRef(null);

            // Load from localStorage on mount
            useEffect(() => {
                const savedKey = localStorage.getItem('ac_last_key');
                if (savedKey) setInputKey(savedKey);
            }, []);

            // Save to localStorage when input changes
            useEffect(() => {
                if (inputKey) localStorage.setItem('ac_last_key', inputKey);
            }, [inputKey]);

            const addLog = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [`[${timestamp}] ${type === 'error' ? '❌' : 'ℹ️'} ${msg}`, ...prev]);
            };

            const handleLoad = () => {
                setLogs([]);
                setOutputKey("");
                if (!inputKey.trim()) {
                    addLog("请输入密钥", "error");
                    return;
                }

                try {
                    let cleanStr = inputKey.trim();
                    if (cleanStr.startsWith("tmdoc_")) {
                        cleanStr = cleanStr.replace("tmdoc_", "");
                    }

                    const compressed = base64ToUint8Array(cleanStr);
                    let decompressed;
                    try {
                        decompressed = pako.inflate(compressed);
                    } catch (e) {
                        try {
                            decompressed = pako.inflate(compressed, { raw: true });
                        } catch (e2) {
                            throw new Error("解压失败，可能是密钥损坏或格式不正确");
                        }
                    }

                    const jsonString = new TextDecoder("utf-8").decode(decompressed);
                    const jsonData = JSON.parse(jsonString);
                    
                    setDecodedData(jsonData);
                    setOriginalTaskId(jsonData.originalTaskId || "unknown");
                    setTaskName(jsonData.taskName || "");
                    setDescription(jsonData.description || "");

                    if (jsonData.parameters) {
                        const rawParams = base64ToUint8Array(jsonData.parameters);
                        const dataView = new DataView(rawParams.buffer);
                        const analyzedParams = analyzeBytes(dataView);
                        setParamsList(analyzedParams);
                        addLog(`成功加载: ${jsonData.originalTaskId || "未知任务"}`, 'success');
                    } else {
                        addLog("警告: 未找到参数数据", 'error');
                        setParamsList([]);
                    }

                } catch (e) {
                    addLog(`加载失败: ${e.message}`, 'error');
                }
            };

            const handleParamChange = (index, newValue) => {
                const newParams = [...paramsList];
                const param = newParams[index];
                
                if (param.type === 'float') {
                    param.value = parseFloat(newValue);
                } else {
                    param.value = parseInt(newValue);
                }
                setParamsList(newParams);
            };

            const resetParam = (index) => {
                const newParams = [...paramsList];
                newParams[index].value = newParams[index].originalValue;
                setParamsList(newParams);
            };

            const generateKey = () => {
                if (!decodedData) return;

                try {
                    const buffer = new ArrayBuffer(paramsList.length * 4);
                    const view = new DataView(buffer);
                    
                    paramsList.forEach((p, i) => {
                        if (p.type === 'float') {
                            view.setFloat32(i * 4, p.value, true);
                        } else {
                            view.setInt32(i * 4, p.value, true);
                        }
                    });

                    const paramBase64 = uint8ArrayToBase64(new Uint8Array(buffer));

                    const newData = { ...decodedData };
                    newData.taskName = taskName;
                    newData.description = description;
                    newData.parameters = paramBase64;
                    
                    const randomHex = Array.from({length: 64}, () => "0123456789ABCDEF".charAt(Math.floor(Math.random() * 16))).join('');
                    newData.taskId = `loc_${randomHex}`;

                    const jsonStr = JSON.stringify(newData); 
                    const compressed = pako.deflate(jsonStr, { level: 9, raw: true });
                    const finalBase64 = uint8ArrayToBase64(compressed);
                    
                    const finalKey = `tmdoc_${finalBase64}`;
                    setOutputKey(finalKey);
                    addLog("生成成功", 'success');

                } catch (e) {
                    addLog(`生成失败: ${e.message}`, 'error');
                }
            };

            const copyToClipboard = () => {
                if (!outputKey) return;
                navigator.clipboard.writeText(outputKey).then(() => {
                    addLog("已复制到剪贴板", 'success');
                });
            };

            const downloadKey = () => {
                if (!outputKey) return;
                const blob = new Blob([outputKey], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `AimChamp_${taskName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                addLog("文件已下载", 'success');
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    setInputKey(event.target.result);
                    addLog("已从文件读取密钥，请点击解析", 'success');
                };
                reader.readAsText(file);
                e.target.value = null; // reset
            };

            // Filtered Params Logic
            const filteredParams = useMemo(() => {
                if (!searchTerm) return paramsList;
                const lowerTerm = searchTerm.toLowerCase();
                return paramsList.filter(p => 
                    p.id.toString().includes(lowerTerm) || 
                    p.value.toString().includes(lowerTerm)
                );
            }, [paramsList, searchTerm]);

            // Icons
            const PlayIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
            const SaveIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
            const CopyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
            const RotateCcwIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 5v7h7"/></svg>;
            const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
            const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto flex flex-col gap-6 font-sans">
                    <header className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-white text-black rounded-none flex items-center justify-center font-black text-2xl tracking-tighter border border-white">
                                AC
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-white tracking-tight uppercase">AimChamp 密钥工坊</h1>
                                <p className="text-neutral-500 text-xs tracking-wider uppercase">Advanced JSON Patcher</p>
                            </div>
                        </div>
                        <div className="text-right hidden md:block">
                            <div className="text-xs text-neutral-600 font-mono">Build v2.1.0</div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* LEFT COLUMN */}
                        <div className="lg:col-span-1 flex flex-col gap-6">
                            
                            {/* Input Panel */}
                            <div className="mono-panel p-5 rounded-sm shadow-2xl">
                                <div className="flex justify-between items-center mb-3">
                                    <label className="text-xs font-bold text-neutral-400 uppercase tracking-wider">Source Key</label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="file" 
                                            ref={fileInputRef} 
                                            onChange={handleFileUpload} 
                                            className="hidden" 
                                            accept=".txt"
                                        />
                                        <button 
                                            onClick={() => fileInputRef.current.click()}
                                            className="text-xs bg-neutral-900 text-neutral-400 hover:text-white border border-neutral-700 hover:border-white px-2 py-1 rounded-sm transition-colors flex items-center gap-1"
                                        >
                                            <UploadIcon /> 导入文件
                                        </button>
                                    </div>
                                </div>
                                <textarea
                                    className="mono-input w-full h-32 rounded-sm p-3 text-xs text-neutral-300 font-mono resize-none focus:ring-1 focus:ring-white"
                                    value={inputKey}
                                    onChange={(e) => setInputKey(e.target.value)}
                                    placeholder="粘贴 tmdoc_ 开头的密钥..."
                                />
                                <button
                                    onClick={handleLoad}
                                    className="mt-4 w-full bg-white text-black hover:bg-neutral-200 font-bold py-2.5 px-4 rounded-sm transition-all flex items-center justify-center gap-2 uppercase tracking-wide text-sm"
                                >
                                    <PlayIcon /> 解析数据 (Decode)
                                </button>
                            </div>

                            {/* Info Panel */}
                            <div className={`mono-panel p-5 rounded-sm shadow-2xl transition-all duration-500 ${decodedData ? 'opacity-100' : 'opacity-50 grayscale pointer-events-none'}`}>
                                <h3 className="text-sm font-bold text-white mb-4 uppercase tracking-wider border-b border-neutral-800 pb-2">Meta Information</h3>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] text-neutral-500 uppercase font-bold tracking-wider block mb-1">Original ID</label>
                                        <div className="text-white font-mono text-xs bg-neutral-900 p-2 rounded-sm border border-neutral-800 break-all">{originalTaskId}</div>
                                    </div>

                                    <div>
                                        <label className="text-[10px] text-neutral-500 uppercase font-bold tracking-wider block mb-1">Task Name</label>
                                        <input 
                                            type="text" 
                                            value={taskName} 
                                            onChange={(e) => setTaskName(e.target.value)}
                                            className="mono-input w-full rounded-sm px-3 py-2 text-sm text-white"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-[10px] text-neutral-500 uppercase font-bold tracking-wider block mb-1">Description</label>
                                        <textarea 
                                            value={description} 
                                            onChange={(e) => setDescription(e.target.value)}
                                            rows={3}
                                            className="mono-input w-full rounded-sm px-3 py-2 text-sm text-white resize-none"
                                        />
                                    </div>
                                </div>
                            </div>

                             {/* Logs */}
                             <div className="mono-panel p-4 rounded-sm shadow-xl flex-grow flex flex-col min-h-[150px]">
                                <h3 className="text-[10px] font-bold text-neutral-500 mb-2 uppercase tracking-wider">System Log</h3>
                                <div className="flex-1 overflow-y-auto max-h-48 bg-black border border-neutral-800 rounded-sm p-2 space-y-1 font-mono text-[10px]">
                                    {logs.length === 0 && <span className="text-neutral-700 italic">... ready ...</span>}
                                    {logs.map((log, i) => (
                                        <div key={i} className="text-neutral-400 border-b border-neutral-900 pb-1 last:border-0">{log}</div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* RIGHT COLUMN */}
                        <div className="lg:col-span-2 flex flex-col gap-6 h-full">
                            
                            {/* Parameters Editor */}
                            <div className="mono-panel rounded-sm shadow-xl flex-1 flex flex-col overflow-hidden min-h-[500px]">
                                <div className="p-4 border-b border-neutral-800 bg-neutral-900 flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <h3 className="text-sm font-bold text-white uppercase tracking-wider">Parameters</h3>
                                        {paramsList.length > 0 && <span className="text-xs text-neutral-500 bg-black px-2 py-0.5 rounded-full border border-neutral-800">{paramsList.length}</span>}
                                    </div>
                                    
                                    <div className="flex gap-3 w-full sm:w-auto">
                                        <input 
                                            type="text"
                                            placeholder="搜索 ID 或数值..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="mono-input text-xs px-3 py-1.5 rounded-sm w-full sm:w-48"
                                            disabled={!decodedData}
                                        />
                                        <div className="flex bg-black rounded-sm border border-neutral-800 p-0.5 shrink-0">
                                            <button 
                                                onClick={() => setActiveTab('editor')}
                                                className={`px-3 py-1 rounded-sm text-xs font-bold transition-all ${activeTab === 'editor' ? 'bg-white text-black' : 'text-neutral-500 hover:text-white'}`}
                                            >
                                                TABLE
                                            </button>
                                            <button 
                                                onClick={() => setActiveTab('raw')}
                                                className={`px-3 py-1 rounded-sm text-xs font-bold transition-all ${activeTab === 'raw' ? 'bg-white text-black' : 'text-neutral-500 hover:text-white'}`}
                                            >
                                                JSON
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto bg-black relative">
                                    {!decodedData ? (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center text-neutral-800 select-none">
                                            <div className="text-8xl mb-4 opacity-50 font-black">AC</div>
                                            <p className="text-xs uppercase tracking-[0.2em]">Waiting for data input</p>
                                        </div>
                                    ) : (
                                        <>
                                            {activeTab === 'editor' ? (
                                                <div className="w-full">
                                                    <table className="w-full text-left border-collapse">
                                                        <thead className="bg-neutral-900 sticky top-0 z-10 text-[10px] uppercase text-neutral-400 font-bold tracking-wider shadow-sm">
                                                            <tr>
                                                                <th className="p-3 border-b border-neutral-800 w-16 text-center">ID</th>
                                                                <th className="p-3 border-b border-neutral-800 w-20 text-center">Type</th>
                                                                <th className="p-3 border-b border-neutral-800">Value</th>
                                                                <th className="p-3 border-b border-neutral-800 w-16"></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-neutral-900">
                                                            {filteredParams.length === 0 && (
                                                                <tr><td colSpan="4" className="p-8 text-center text-neutral-600 text-xs">无匹配参数</td></tr>
                                                            )}
                                                            {filteredParams.map((param) => {
                                                                // Use original index as key if filtering
                                                                const actualIndex = param.id; 
                                                                const isModified = param.value !== param.originalValue;

                                                                return (
                                                                    <tr key={actualIndex} className={`group transition-colors ${isModified ? 'bg-neutral-900/40' : 'hover:bg-neutral-900/20'}`}>
                                                                        <td className="p-2 text-center text-neutral-500 font-mono text-xs border-r border-neutral-900">{actualIndex}</td>
                                                                        <td className="p-2 text-center border-r border-neutral-900">
                                                                            <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded-sm uppercase ${param.type === 'float' ? 'bg-neutral-800 text-neutral-300' : 'bg-white text-black'}`}>
                                                                                {param.type}
                                                                            </span>
                                                                        </td>
                                                                        <td className="p-2 relative">
                                                                            <input 
                                                                                type="number"
                                                                                step={param.type === 'float' ? "0.01" : "1"}
                                                                                value={param.value}
                                                                                onChange={(e) => handleParamChange(actualIndex, e.target.value)}
                                                                                className={`w-full bg-transparent border-b ${isModified ? 'border-white text-white font-bold' : 'border-transparent text-neutral-300'} hover:border-neutral-600 focus:border-white rounded-none px-2 py-1 font-mono text-sm focus:outline-none transition-all`}
                                                                            />
                                                                            {isModified && <span className="absolute right-2 top-3 w-1.5 h-1.5 bg-white rounded-full"></span>}
                                                                        </td>
                                                                        <td className="p-2 text-center">
                                                                            {isModified && (
                                                                                <button 
                                                                                    onClick={() => resetParam(actualIndex)}
                                                                                    title="重置"
                                                                                    className="text-neutral-500 hover:text-white transition-colors p-1"
                                                                                >
                                                                                    <RotateCcwIcon />
                                                                                </button>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ) : (
                                                <div className="p-4">
                                                    <pre className="text-[10px] text-neutral-400 font-mono overflow-x-auto p-4 rounded-sm border border-neutral-800">
                                                        {JSON.stringify(decodedData, null, 2)}
                                                    </pre>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* Output Section */}
                            <div className="mono-panel p-5 rounded-sm shadow-xl border-t-2 border-white">
                                <div className="flex justify-between items-end mb-4">
                                    <div>
                                        <h3 className="text-sm font-bold text-white uppercase tracking-wider">Output Key</h3>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={downloadKey}
                                            disabled={!outputKey}
                                            className={`border border-neutral-700 hover:border-white text-neutral-300 hover:text-white font-bold py-1.5 px-3 rounded-sm text-xs flex items-center gap-2 transition-all ${!outputKey ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            <DownloadIcon /> 下载 .txt
                                        </button>
                                        <button
                                            onClick={generateKey}
                                            disabled={!decodedData}
                                            className={`bg-white text-black hover:bg-neutral-200 font-bold py-1.5 px-6 rounded-sm text-sm shadow-lg flex items-center gap-2 transition-all uppercase tracking-wide ${!decodedData ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            <SaveIcon /> 生成 (Encode)
                                        </button>
                                    </div>
                                </div>

                                <div className="relative group">
                                    <textarea
                                        readOnly
                                        value={outputKey}
                                        placeholder="Generate key to see output..."
                                        className="mono-input w-full h-24 rounded-sm p-3 text-xs text-neutral-400 font-mono resize-none focus:ring-1 focus:ring-white focus:text-white transition-colors"
                                    />
                                    {outputKey && (
                                        <button 
                                            onClick={copyToClipboard}
                                            className="absolute top-2 right-2 bg-white text-black hover:bg-neutral-200 px-3 py-1 rounded-sm text-xs font-bold flex items-center gap-1 transition-colors opacity-0 group-hover:opacity-100 shadow-lg"
                                        >
                                            <CopyIcon /> COPY
                                        </button>
                                    )}
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
